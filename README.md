# DWX-52D 밀링 작업 리포트 자동 전송 시스템

JSON 형식의 밀링 작업 로그를 읽어서 API로 자동 전송하는 프로그램입니다.

## 프로젝트 구조

```
get-file-sys/
├── config.js          # 설정 파일 (디렉토리 경로, API URL 등)
├── server.js          # 메인 프로그램 (파일 읽기, 리포트 출력)
├── apiService.js      # API 호출 전용 모듈
├── logger.js          # 로그 파일 관리 모듈
├── logs/              # 로그 파일 저장 디렉토리 (자동 생성)
│   ├── log_YYYY-MM-DD.txt     # 일별 로그 파일
│   └── errors/                # 오류 로그 전용 폴더
│       └── error_YYYY-MM-DD.txt  # 일별 오류 로그
├── package.json       # 프로젝트 의존성
├── .gitignore         # Git 제외 파일 목록
└── README.md          # 사용 설명서
```

## 주요 기능

1. **JSON 파일 자동 읽기**: 지정된 폴더의 모든 JSON 파일을 자동으로 읽습니다
2. **한글 인코딩 복원**: euc-jp로 잘못 인코딩된 한글 이름을 자동으로 복원합니다
3. **리포트 생성**: 작업 정보를 보기 좋은 형식으로 로그 파일에 저장합니다
4. **일별 로그 관리**: 날짜별로 로그 파일이 자동 생성됩니다 (예: `log_2025-09-30.txt`)
5. **중복 체크 및 자동 건너뛰기** ⚡: API에서 기존 주문 리스트를 조회하여 이미 전송된 주문은 자동으로 건너뜁니다
6. **API 자동 전송**: 새로운 작업 정보만 외부 API로 전송합니다

## 설치 방법

```bash
npm install
```

## 설정 방법

`config.js` 파일에서 다음 항목을 수정하세요:

```javascript
module.exports = {
    // JSON 파일이 있는 디렉토리 경로
    targetDirectory: 'C:/Users/yoon/Desktop/log/job_log',
    
    // API 엔드포인트 URL
    apiUrl: 'http://localhost:9090/api/order/external/create',        // 주문 생성 (completedOrders 포함)
    apiUpdateUrl: 'http://localhost:9090/api/order/external/update',  // 주문 업데이트
    
    port: 3000,
    logLevel: 'info',
    includeEmojis: true
};
```

### 주요 설정 항목

- **targetDirectory**: JSON 파일들이 저장된 폴더 경로
- **apiUrl**: 작업 정보를 전송할 API 엔드포인트 (생성 시 completedOrders 함께 반환)
- **apiUpdateUrl**: 주문 업데이트 API URL (선택사항)

## 실행 방법

```bash
node server.js
```

## API 연동 방식 🔄

### 중복 방지 메커니즘

프로그램은 **API 응답의 `completedOrders`**를 활용하여 중복 전송을 자동으로 방지합니다.

#### 처리 흐름

```
1️⃣ 첫 번째 파일 처리
   파일 읽기 → 주문자: "이수경", 시작: "2025-07-22 10:16", 상태: "완료"
   → completedOrders에서 검색 (없음)
   → POST /api/order/external/create
   → 응답: { completedOrders: [...], newOrder: {...} }
   → completedOrders 저장 (예: 100건)

2️⃣ 두 번째 파일 처리
   파일 읽기 → 주문자: "김상배", 시작: "2025-07-24 09:24", 상태: "완료"
   → completedOrders에서 검색
   
   ✅ 케이스 1: 일치하는 주문 없음
      → CREATE API 호출 → 신규 생성

   ✅ 케이스 2: 일치하는 주문 있음 & DB 상태 "완료"
      → ⏭️ 건너뛰기 (중복)

   ✅ 케이스 3: 일치하는 주문 있음 & DB 상태 "작업중" & 파일 상태 "완료"
      → UPDATE API 호출 → "작업중" → "완료"로 업데이트

3️⃣ 이후 파일들도 동일하게 처리
   → completedOrders 점진적 증가
   → 스마트하게 생성/업데이트/건너뛰기 자동 판단
```

### API 전송 데이터 형식

```json
{
  "equipmentModel": "DWX-52D",
  "orderer": "이수경",
  "workStartTime": "2025-07-22 10:16:00",
  "workEndTime": "2025-07-22 10:43:00",
  "totalWorkTime": 27,
  "result": "완료",
  "error": null
}
```

### API 응답 구조 (필수!)

`create` API는 반드시 다음 형식으로 응답해야 합니다:

```json
{
  "success": true,
  "message": "주문이 성공적으로 생성되었습니다.",
  "data": {
    "completedOrders": [
      {
        "orderer": "이수경",
        "workStartTime": "2025-07-22T10:16:00.000+09:00",
        ...
      }
    ],
    "newOrder": {
      "orderCode": "ORD-2025-0001",
      ...
    }
  }
}
```

### 필드 설명

- **equipmentModel**: 장비 모델명 (예: DWX-52D)
- **orderer**: 주문자 이름 (한글로 자동 변환)
- **workStartTime**: 작업 시작 시간 (yyyy-MM-dd HH:mm:ss)
- **workEndTime**: 작업 종료 시간 (yyyy-MM-dd HH:mm:ss)
- **totalWorkTime**: 총 작업 시간 (분 단위)
- **result**: 작업 결과 ("완료" 또는 "실패")
- **error**: 오류 메시지 (오류가 있을 경우)

## 실행 결과

### 시나리오 1: 첫 실행 (모든 파일 신규)
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 처리 완료!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 신규 생성: 16건
🔄 업데이트: 0건
⏭️  건너뜀: 0건
❌ 실패: 0건
📁 총 파일: 16개
📋 DB 완료된 주문: 16건

📝 로그 파일: C:\Users\yoon\Desktop\work\get-file-sys\logs\log_2025-09-30.txt
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 시나리오 2: 재실행 (모두 이미 완료됨) ⚡
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 처리 완료!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 신규 생성: 0건
🔄 업데이트: 0건
⏭️  건너뜀: 16건 (이미 완료)  ← 모두 건너뜀!
❌ 실패: 0건
📁 총 파일: 16개
📋 DB 완료된 주문: 16건
⚡ 절약된 시간: 약 8초
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 시나리오 3: 혼합 (신규 + 업데이트 + 완료)
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 처리 완료!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 신규 생성: 3건          ← 새로운 주문
🔄 업데이트: 5건 (작업중 → 완료)  ← DB에 "작업중"이던 것 → "완료"로
⏭️  건너뜀: 8건 (이미 완료)      ← DB에 이미 "완료"로 있음
❌ 실패: 0건
📁 총 파일: 16개
📋 DB 완료된 주문: 21건
⚡ 절약된 시간: 약 4초
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 로그 파일 내용 (logs/log_2025-09-30.txt)

**개선된 로그 형식** - 더 읽기 쉽고 명확하게 개선되었습니다!
```
[15:38:42] ℹ️ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[15:38:42] ℹ️ 📄 [16/16] DWINDEX_20250807103813-v3.json
[15:38:42] ℹ️ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📋 DWX-52D 밀링 작업 리포트
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


[15:38:42] ℹ️ ┌─ 장비 및 작업 정보
[15:38:42] ℹ️ │  • 장비 모델: DWX-52D
[15:38:42] ℹ️ │  • 시리얼 번호: KGE3279
[15:38:42] ℹ️ │  • 주문자: 김상배
[15:38:42] ℹ️ │  • 작업 이름: Job_2025-08-07_09-53-48...
[15:38:42] ℹ️ │  • 작업 유형: Full Contour Bridge (2개)
[15:38:42] ℹ️ │  • 원본 파일: 20250807_0922_김상배a3.5삼_0.stl
[15:38:42] ℹ️ └─────────────────────────

[15:38:42] ℹ️ ┌─ API 전송
[15:38:42] ℹ️ │  • 주문자: 김상배
[15:38:42] ℹ️ │  • 장비: DWX-52D
[15:38:42] ℹ️ │  • 작업시간: 35분
[15:38:42] ℹ️ │  • 결과: 완료
[15:38:42] ℹ️ │
[15:38:42] ℹ️ │  📦 전송 데이터:
[15:38:42] ℹ️    {
[15:38:42] ℹ️      "equipmentModel": "DWX-52D",
[15:38:42] ℹ️      "orderer": "김상배",
[15:38:42] ℹ️      "totalWorkTime": 35,
[15:38:42] ℹ️      "result": "완료"
[15:38:42] ℹ️    }
[15:38:42] ℹ️ │
[15:38:42] ℹ️ │  🚀 API 요청 중...
[15:38:42] ✅ API 전송 성공: 주문이 성공적으로 생성되었습니다.
[15:38:42] ℹ️ │  • 주문 코드: ORD-2025-0065
[15:38:42] ℹ️ └─────────────────────────
[15:38:42] ✅ 파일 처리 완료: DWINDEX_20250807103813-v3.json

════════════════════════════════════════════════════════════

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📋 처리 완료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


[15:38:43] ✅ 성공: 16건
[15:38:43] ℹ️ 실패: 0건
[15:38:43] ℹ️ 총 파일: 16개
════════════════════════════════════════════════════════════
```

## 모듈 설명

### `server.js`
- 메인 프로그램
- JSON 파일 읽기
- 한글 인코딩 변환
- 리포트 생성
- 파일 처리 흐름 제어

### `apiService.js`
- API 호출 전용 모듈
- 데이터 포맷팅 (날짜, 시간)
- HTTP 요청 전송
- **기존 주문 목록 조회** (`getExistingOrders`)
- **중복 체크** (`isOrderExists`)
- 에러 처리

### `logger.js`
- 로그 파일 관리 모듈
- 일별 로그 파일 자동 생성
- 로그 레벨별 기록 (INFO, SUCCESS, ERROR, WARN, DEBUG)
- 타임스탬프 자동 추가 (간결한 HH:MM:SS 형식)
- 아이콘 자동 삽입 (ℹ️, ✅, ❌, ⚠️, 🔍)
- 섹션 박스 형태 지원 (`section()`, `item()`, `sectionEnd()`)
- UTF-8 인코딩으로 저장
- **오류 로그 자동 분리** - ERROR 레벨은 `logs/errors/` 폴더에도 별도 저장

### `config.js`
- 설정 관리
- 디렉토리 경로
- API 엔드포인트 URL

## 문제 해결

### API 연결 실패

API 서버가 실행 중인지 확인하세요:
- API URL이 올바른지 확인 (`config.js` 파일)
- 서버가 8080 포트에서 실행 중인지 확인
- 방화벽이 연결을 차단하지 않는지 확인

### 한글이 깨져서 표시되는 경우

이 프로그램은 자동으로 euc-jp에서 euc-kr로 변환합니다. 
만약 여전히 깨진다면 원본 JSON 파일의 인코딩을 확인하세요.

### JSON 파일을 찾을 수 없는 경우

`config.js`의 `targetDirectory` 경로가 올바른지 확인하세요.

### 로그 파일 확인

로그 파일은 `logs/` 디렉토리에 일별로 생성됩니다:

#### 일반 로그 (`logs/log_YYYY-MM-DD.txt`)
- 모든 작업 내역이 기록됩니다
- 타임스탬프: `[HH:MM:SS]` 형식 (간결함)
- 아이콘: ℹ️ (정보), ✅ (성공), ❌ (에러), ⚠️ (경고), 🔍 (디버그)
- 섹션별로 박스 형태로 구분 (`┌─`, `│`, `└─`)
- 인코딩: UTF-8

#### 오류 로그 (`logs/errors/error_YYYY-MM-DD.txt`)
- **에러 메시지만** 별도로 기록됩니다
- 일반 로그와 동일한 형식
- 문제 해결 시 이 파일만 확인하면 됩니다

로그 파일 확인 방법:
```bash
# Windows 메모장
notepad logs\log_2025-09-30.txt

# VS Code (권장 - UTF-8 완벽 지원)
code logs\log_2025-09-30.txt

# 오류 로그 확인
code logs\errors\error_2025-09-30.txt
```

## 개발자 가이드

### API 서비스 모듈 사용법

`apiService.js`는 독립적인 모듈로 다른 프로젝트에서도 사용 가능합니다:

```javascript
const { sendToAPI } = require('./apiService');
const logger = require('./logger');

// 데이터 전송
const result = await sendToAPI(jsonData, extractCustomerName, logger);

if (result.success) {
    logger.success('전송 성공:', result.response);
} else {
    logger.error('전송 실패:', result.error);
}
```

### 로거 모듈 사용법

`logger.js`는 다양한 로깅 기능을 제공합니다:

```javascript
const logger = require('./logger');

// 기본 로그 (아이콘 자동 추가)
logger.info('정보 메시지');       // ℹ️
logger.success('성공 메시지');    // ✅
logger.error('에러 메시지');      // ❌ (자동으로 errors/ 폴더에도 기록)
logger.warn('경고 메시지');       // ⚠️
logger.debug('디버그 메시지');    // 🔍

// 제목 (큰 박스)
logger.title('DWX-52D 작업 리포트');

// 섹션 (박스 형태)
logger.section('장비 정보');
logger.item('모델명', 'DWX-52D');
logger.item('주문자', '김상배');
logger.sectionEnd();

// 구분선
logger.separator('═', 60);  // ════════...
logger.separator('━', 60);  // ━━━━━...

// 빈 줄
logger.blank();

// JSON 객체 로그 (자동 들여쓰기)
logger.json({ equipmentModel: 'DWX-52D', orderer: '김상배' }, '전송 데이터');

// 현재 로그 파일 경로 가져오기
const logFile = logger.getCurrentLogFile();
console.log('로그 파일:', logFile);
```

### 로그 레벨과 아이콘

| 레벨 | 아이콘 | 용도 | 에러 폴더 저장 |
|------|--------|------|----------------|
| **INFO** | ℹ️ | 일반 정보 | ❌ |
| **SUCCESS** | ✅ | 성공 메시지 | ❌ |
| **ERROR** | ❌ | 오류 메시지 | ✅ (자동 저장) |
| **WARN** | ⚠️ | 경고 메시지 | ❌ |
| **DEBUG** | 🔍 | 디버그 메시지 | ❌ |

## 성능 분석 ⚡

### 파일 개수별 예상 처리 시간

#### 첫 실행 (모든 파일 전송)
| 파일 개수 | 예상 시간 | 비고 |
|----------|----------|------|
| 16개 | 8초 | 현재 상태 |
| 100개 | 55초 | 소규모 |
| 1,000개 | 9분 | 중규모 |
| 5,000개 | 46분 | 대규모 |
| 10,000개 | 92분 | 초대규모 |

#### 재실행 (95% 중복 시나리오)
| 파일 개수 | 중복 건수 | 예상 시간 | 성능 향상 |
|----------|----------|----------|-----------|
| 100개 | 95개 | **10초** | 5.5배 빠름 ⚡ |
| 1,000개 | 950개 | **1분** | 9배 빠름 ⚡⚡ |
| 5,000개 | 4,800개 | **6분** | 8배 빠름 ⚡⚡ |
| 10,000개 | 9,500개 | **13분** | 7배 빠름 ⚡⚡ |

### 핵심 최적화

1. **스마트 중복 체크**: 이미 전송된 주문은 자동으로 건너뜀
   - 첫 번째 `create` API 호출 시 `completedOrders` 리스트 받음
   - 각 파일 처리 전에 이 리스트로 중복 확인
   - 중복이면 API 호출 없이 즉시 건너뛰기 (딜레이도 없음)
   - 새 주문 생성 후 `completedOrders` 업데이트

2. **효율적인 처리 순서**
   ```
   1️⃣ 첫 번째 파일 → API 호출 → completedOrders 받음 (예: 100건)
   2️⃣ 두 번째 파일 → completedOrders에서 중복 체크 → 중복이면 건너뜀
   3️⃣ 세 번째 파일 → 중복 아니면 API 호출 → 업데이트된 completedOrders 받음 (101건)
   ...반복
   ```

3. **절약된 시간 표시**
   - 중복 파일 × 0.5초 = 절약 시간
   - 예: 15개 중복 → 7초 절약

4. **실제 사용 시나리오**
   - 매일 새 파일 10-20개만 추가됨
   - 대부분의 파일은 이미 처리됨
   - **재실행 시 몇 초 만에 완료** ✨

### 스마트 처리 로직

프로그램은 DB 상태와 파일 데이터를 비교하여 자동으로 적절한 작업을 수행합니다.

| DB 상태 | 파일 상태 | 동작 | API | 설명 |
|---------|----------|------|-----|------|
| 없음 | 완료 | ✅ 생성 | CREATE | 신규 주문 |
| 없음 | 작업중 | ✅ 생성 | CREATE | 신규 주문 |
| 작업중 | 완료 | 🔄 업데이트 | UPDATE | 작업 완료됨 |
| 작업중 | 작업중 | ⏭️ 건너뛰기 | - | 변경 없음 |
| 완료 | 완료 | ⏭️ 건너뛰기 | - | 이미 처리됨 |
| 완료 | 작업중 | ⏭️ 건너뛰기 | - | DB가 최신 |

### 중복 판별 방식

```
주문자 이름 + 작업 시작 시간 (분 단위) = 고유 식별자

예시:
- "이수경" + "2025-07-22 10:16" → 같은 주문
- "이수경" + "2025-07-22 14:30" → 다른 주문

비교 방법:
1. completedOrders에서 주문자 이름 일치 확인
2. 작업 시작 시간 일치 확인 (분 단위까지)
3. 둘 다 일치하면 → 기존 주문의 상태 확인
   - "완료"면 → 건너뛰기
   - "작업중"이고 파일이 "완료"면 → 업데이트
```

## 라이센스

MIT